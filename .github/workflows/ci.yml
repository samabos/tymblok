name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/tymblok-api

jobs:
  # --- CI Jobs (always run) ---

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  test-shared:
    name: Test Shared Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @tymblok/shared build
      - run: pnpm --filter @tymblok/shared typecheck

  test-api:
    name: Test API
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tymblok_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - run: cd apps/api && dotnet restore
      - run: cd apps/api && dotnet build --no-restore
      - run: cd apps/api && dotnet test --no-build

  test-mobile:
    name: Test Mobile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @tymblok/shared build
      - run: pnpm --filter @tymblok/theme build
      - run: pnpm --filter @tymblok/api-client build
      - run: pnpm --filter @tymblok/ui build
      - run: pnpm --filter @tymblok/mobile typecheck
      - run: pnpm --filter @tymblok/mobile test

  # --- Build Docker Image (after API tests pass) ---

  build-and-push:
    name: Build & Push Image
    needs: [test-api]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'latest' || 'staging' }}

  # --- Staging Deploy (PRs → tymblok-dev) ---

  deploy-staging:
    name: Deploy Staging
    needs: [build-and-push]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    environment: staging
    env:
      AZURE_RG: tymblok-dev
      AZURE_PLAN: tymblok-plan
      AZURE_WEBAPP_NAME: tymblok-api-staging
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure App Service exists
        run: |
          if ! az appservice plan show --name ${{ env.AZURE_PLAN }} --resource-group ${{ env.AZURE_RG }} &>/dev/null; then
            echo "Creating App Service Plan..."
            az appservice plan create \
              --name ${{ env.AZURE_PLAN }} \
              --resource-group ${{ env.AZURE_RG }} \
              --location uksouth \
              --sku B1 \
              --is-linux
          fi

          if ! az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RG }} &>/dev/null; then
            echo "Creating Web App..."
            az webapp create \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RG }} \
              --plan ${{ env.AZURE_PLAN }} \
              --deployment-container-image-name ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging
          fi

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Set App Settings
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          app-settings-json: |
            [
              { "name": "ConnectionStrings__DefaultConnection", "value": "${{ secrets.DATABASE_URL }}", "slotSetting": false },
              { "name": "Jwt__Secret", "value": "${{ secrets.JWT_SECRET }}", "slotSetting": false },
              { "name": "OAuth__Google__ClientId", "value": "${{ secrets.GOOGLE_CLIENT_ID }}", "slotSetting": false },
              { "name": "OAuth__Google__ClientSecret", "value": "${{ secrets.GOOGLE_CLIENT_SECRET }}", "slotSetting": false },
              { "name": "OAuth__GitHub__ClientId", "value": "${{ secrets.GITHUB_OAUTH_CLIENT_ID }}", "slotSetting": false },
              { "name": "OAuth__GitHub__ClientSecret", "value": "${{ secrets.GITHUB_OAUTH_CLIENT_SECRET }}", "slotSetting": false },
              { "name": "OAuth__WebCallbackUrl", "value": "${{ vars.WEB_CALLBACK_URL }}", "slotSetting": false },
              { "name": "Integrations__EncryptionKey", "value": "${{ secrets.INTEGRATION_ENCRYPTION_KEY }}", "slotSetting": false },
              { "name": "Email__SmtpHost", "value": "${{ vars.SMTP_HOST }}", "slotSetting": false },
              { "name": "Email__SmtpPort", "value": "${{ vars.SMTP_PORT }}", "slotSetting": false },
              { "name": "Email__SmtpUsername", "value": "${{ vars.SMTP_USERNAME }}", "slotSetting": false },
              { "name": "Email__SmtpPassword", "value": "${{ secrets.SMTP_PASSWORD }}", "slotSetting": false },
              { "name": "Email__UseSsl", "value": "true", "slotSetting": false },
              { "name": "Email__UseStartTls", "value": "false", "slotSetting": false },
              { "name": "Email__FromEmail", "value": "noreply@tymblok.app", "slotSetting": false },
              { "name": "Email__FromName", "value": "Tymblok", "slotSetting": false },
              { "name": "Email__AppBaseUrl", "value": "${{ vars.APP_BASE_URL }}", "slotSetting": false }
            ]

  # --- Production Deploy (main push → tymblok-prod) ---

  deploy-production:
    name: Deploy Production
    needs: [build-and-push]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    env:
      AZURE_RG: tymblok-prod
      AZURE_PLAN: tymblok-prod-plan
      AZURE_WEBAPP_NAME: tymblok-api
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure App Service exists
        run: |
          # Create resource group if it doesn't exist
          if ! az group show --name ${{ env.AZURE_RG }} &>/dev/null; then
            echo "Creating Resource Group..."
            az group create --name ${{ env.AZURE_RG }} --location uksouth
          fi

          if ! az appservice plan show --name ${{ env.AZURE_PLAN }} --resource-group ${{ env.AZURE_RG }} &>/dev/null; then
            echo "Creating App Service Plan..."
            az appservice plan create \
              --name ${{ env.AZURE_PLAN }} \
              --resource-group ${{ env.AZURE_RG }} \
              --location uksouth \
              --sku B1 \
              --is-linux
          fi

          if ! az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RG }} &>/dev/null; then
            echo "Creating Web App..."
            az webapp create \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RG }} \
              --plan ${{ env.AZURE_PLAN }} \
              --deployment-container-image-name ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          fi

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          resource-group-name: ${{ env.AZURE_RG }}
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Set App Settings
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          app-settings-json: |
            [
              { "name": "ConnectionStrings__DefaultConnection", "value": "${{ secrets.PROD_DATABASE_URL }}", "slotSetting": false },
              { "name": "Jwt__Secret", "value": "${{ secrets.PROD_JWT_SECRET }}", "slotSetting": false },
              { "name": "OAuth__Google__ClientId", "value": "${{ secrets.GOOGLE_CLIENT_ID }}", "slotSetting": false },
              { "name": "OAuth__Google__ClientSecret", "value": "${{ secrets.GOOGLE_CLIENT_SECRET }}", "slotSetting": false },
              { "name": "OAuth__GitHub__ClientId", "value": "${{ secrets.GITHUB_OAUTH_CLIENT_ID }}", "slotSetting": false },
              { "name": "OAuth__GitHub__ClientSecret", "value": "${{ secrets.GITHUB_OAUTH_CLIENT_SECRET }}", "slotSetting": false },
              { "name": "OAuth__WebCallbackUrl", "value": "${{ vars.PROD_WEB_CALLBACK_URL }}", "slotSetting": false },
              { "name": "Integrations__EncryptionKey", "value": "${{ secrets.PROD_INTEGRATION_ENCRYPTION_KEY }}", "slotSetting": false },
              { "name": "Email__SmtpHost", "value": "${{ vars.SMTP_HOST }}", "slotSetting": false },
              { "name": "Email__SmtpPort", "value": "${{ vars.SMTP_PORT }}", "slotSetting": false },
              { "name": "Email__SmtpUsername", "value": "${{ vars.SMTP_USERNAME }}", "slotSetting": false },
              { "name": "Email__SmtpPassword", "value": "${{ secrets.SMTP_PASSWORD }}", "slotSetting": false },
              { "name": "Email__UseSsl", "value": "true", "slotSetting": false },
              { "name": "Email__UseStartTls", "value": "false", "slotSetting": false },
              { "name": "Email__FromEmail", "value": "noreply@tymblok.app", "slotSetting": false },
              { "name": "Email__FromName", "value": "Tymblok", "slotSetting": false },
              { "name": "Email__AppBaseUrl", "value": "${{ vars.PROD_APP_BASE_URL }}", "slotSetting": false }
            ]

      - name: Configure Custom Domain
        run: |
          # Add custom domain if not already configured
          DOMAINS=$(az webapp config hostname list --webapp-name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RG }} --query "[].name" -o tsv)
          if ! echo "$DOMAINS" | grep -q "api.tymblok.app"; then
            echo "Custom domain not yet configured. Add a CNAME record pointing api.tymblok.app to ${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net, then run:"
            echo "  az webapp config hostname add --webapp-name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RG }} --hostname api.tymblok.app"
          else
            echo "Custom domain already configured"
          fi

  # --- EAS Build (mobile) ---

  build-mobile:
    name: Build Mobile (Android)
    needs: [test-mobile]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: |
          pnpm --filter @tymblok/shared build
          pnpm --filter @tymblok/theme build
          pnpm --filter @tymblok/api-client build
          pnpm --filter @tymblok/ui build

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android APK (preview)
        working-directory: apps/mobile
        run: eas build --platform android --profile preview --non-interactive
